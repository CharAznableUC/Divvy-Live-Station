<!DOCTYPE html>
<html>
<head>
  <title>Divvy Live Stations Map</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 100vh; margin: 0; padding: 0; }
    body { margin: 0; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const campusBounds = L.latLngBounds(
      L.latLng(41.782, -87.620),
      L.latLng(41.803, -87.580)
    );

    const map = L.map('map', {
      maxBounds: campusBounds,
      maxBoundsViscosity: 1.0
    }).setView([41.7925, -87.6000], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let markersLayer = L.layerGroup().addTo(map);

    function fetchAndUpdateStations() {
      fetch("https://gbfs.divvybikes.com/gbfs/en/station_status.json")
        .then(response => response.json())
        .then(statusData => {
          fetch("https://gbfs.divvybikes.com/gbfs/en/station_information.json")
            .then(response => response.json())
            .then(infoData => {
              const statusDict = {};
              statusData.data.stations.forEach(s => statusDict[s.station_id] = s);

              markersLayer.clearLayers();

              infoData.data.stations.forEach(station => {
                const status = statusDict[station.station_id];
                if (!status) return;

                const popupContent = `
                  <strong>${station.name}</strong><br>
                  ðŸš² Classic Bikes: ${status.num_bikes_available}<br>
                  âš¡ E-bikes: ${status.num_ebikes_available ?? 'N/A'}<br>
                  ðŸ›´ Scooters: ${status.num_scooters_available ?? 'N/A'}<br>
                  ðŸ”Œ Open Docks: ${status.num_docks_available}<br>
                `;

                const marker = L.circleMarker([station.lat, station.lon], {
                  radius: 8.5,
                  color: status.num_bikes_available > 0 ? 'green' : 'red',
                  fillOpacity: 0.8
                });

                if (campusBounds.contains([station.lat, station.lon])) {
                  markersLayer.addLayer(marker.bindPopup(popupContent));
                }
              });
            });
        });
    }

    fetchAndUpdateStations();
    setInterval(fetchAndUpdateStations, 30000);
  </script>
</body>
</html>
